# 止损保护机制更新文档

## 更新日期

2025-11-07

## 问题背景

原有的 `-30%` 固定强制平仓规则与科学止损系统存在逻辑冲突：

### 冲突示例

```typescript
原规则：单笔亏损 ≤ -30%：强制平仓

科学止损：
- 超短线：0.3%-2.0%（ATR 1.5x）
- 波段趋势：1.0%-6.0%（ATR 2.5x）
- 平衡策略：0.5%-5.0%（ATR 2.0x）

10倍杠杆场景：
- -30% pnl_percent = -3% 价格变动
- 科学止损可能设置在 -8% pnl_percent（0.8%价格变动）
- 结果：-30%会在科学止损之前触发，失去意义
```

## 解决方案

### 采用方案A：移除固定值，改为基于科学止损阈值的动态保护

## 核心改进

### 1. AI 提示词层面

**旧表述：**

```typescript
【系统硬性底线】
* 单笔亏损 ≤ -30%：强制平仓
* 持仓时间 ≥ 36小时：强制平仓
```

**新表述：**

```typescript
【系统硬性底线 - 强制执行】
* 科学止损保护：交易所服务器端24/7监控，触及止损位立即平仓
* 极端保护：如亏损超过科学止损阈值且止损单未生效，系统强制介入
* 持仓时间 ≥ 36小时：强制平仓
```

### 2. 系统代码层面 (tradingLoop.ts)

**旧逻辑：**

```typescript
const EXTREME_STOP_LOSS = -30; // 固定值

if (pnlPercent <= EXTREME_STOP_LOSS) {
  closeReason = `触发极端止损保护 (${pnlPercent}% ≤ -30%)`;
}
```

**新逻辑：**

```typescript
// 根据杠杆倍数动态计算极端止损阈值
const EXTREME_STOP_LOSS_BASE = -8; // 基准：-8% pnl_percent
const LEVERAGE_ADJUSTMENT = Math.min(leverage / 10, 1.5); // 杠杆调整系数
const EXTREME_STOP_LOSS = EXTREME_STOP_LOSS_BASE * LEVERAGE_ADJUSTMENT;

if (pnlPercent <= EXTREME_STOP_LOSS) {
  closeReason = `科学止损失效保护触发 (${pnlPercent}% ≤ ${EXTREME_STOP_LOSS}%)`;
  logger.error(`正常情况下科学止损单应该已在交易所服务器端触发，请检查止损单状态`);
}
```

## 新机制说明

### 极端止损阈值计算

```typescript
基准值 = -8% pnl_percent
杠杆调整系数 = min(leverage / 10, 1.5)
极端止损线 = 基准值 × 杠杆调整系数
```

### 示例计算

| 杠杆倍数 | 调整系数 | 极端止损线 | 说明 |
|---------|---------|-----------|------|
| 5x      | 0.5     | -4%       | 低杠杆，较紧的保护 |
| 10x     | 1.0     | -8%       | 标准杠杆，标准保护 |
| 15x     | 1.5     | -12%      | 高杠杆，最大保护 |
| 20x     | 1.5     | -12%      | 超高杠杆，保持最大保护 |

### 与科学止损的关系

| 策略 | 科学止损最大距离 | 极端保护线 (10x杠杆) | 安全缓冲 |
|-----|-----------------|-------------------|---------|
| 超短线 | -2.0% | -8% | 6% |
| 波段趋势 | -6.0% | -8% | 2% |
| 平衡 | -5.0% | -8% | 3% |
| 激进 | -5.0% | -8% | 3% |

## 核心优势

### 1. 消除逻辑冲突

- **科学止损优先**：交易所服务器端自动执行，24/7保护
- **系统兜底**：只在科学止损失效时才介入
- **动态调整**：根据实际杠杆倍数动态计算保护线

### 2. 更合理的保护

- **低杠杆**（5x）：极端保护线 -4%，较紧
- **标准杠杆**（10x）：极端保护线 -8%，标准
- **高杠杆**（15x+）：极端保护线 -12%，放宽

### 3. 明确的定位

- **一级保护**：科学止损（智能、动态、实时）
- **二级保护**：极端保护（兜底、静态、被动）

## 日志和监控

### 正常情况

```typescript
BTC 极端止损检查: 当前盈亏=-5.2%, 极端止损线=-8.0% (杠杆10x), 科学止损应该已在交易所服务器端执行
```

### 异常情况（触发极端保护）

```typescript
⚠️ 科学止损失效保护触发 (-9.5% ≤ -8.0%，杠杆10x) - 正常情况下科学止损单应该已在交易所服务器端触发，请检查止损单状态
```

## 风险提示

### 极端保护触发意味着

1. **科学止损单可能失效**：需要检查交易所订单状态
2. **极端行情**：可能出现闪崩、流动性枯竭等情况
3. **系统异常**：止损单设置可能有问题

### 监控建议

- 定期检查止损单是否正常设置
- 关注极端保护触发频率（正常应该极少触发）
- 如频繁触发，需要排查科学止损系统

## 相关文件

### 修改文件

1. `src/agents/tradingAgent.ts`
   - 更新 AI 提示词中的风控底线描述
   - 移除所有 -30% 固定值的提及
   - 强调科学止损保护机制

2. `src/scheduler/tradingLoop.ts`
   - 修改极端止损检查逻辑
   - 改为基于杠杆的动态计算
   - 增强日志说明

### 相关文档

- `docs/STOP_LOSS_INTEGRATION.md` - 科学止损集成说明
- `docs/STOP_LOSS_QUICK_GUIDE.md` - 科学止损快速指南
- `docs/POSITION_MANAGEMENT_IMPROVEMENT.md` - 持仓管理改进

## 总结

这次更新从根本上解决了固定 `-30%` 规则与科学止损的逻辑冲突：

1. **移除固定值**：不再使用 -30% 这个与科学止损冲突的固定阈值
2. **动态计算**：根据实际杠杆倍数动态计算极端保护线
3. **明确定位**：极端保护是"科学止损失效时的最后防线"，不是常规风控手段
4. **合理缓冲**：极端保护线比科学止损最大距离留有安全缓冲

通过这些改进，系统拥有了更加合理和协调的多层止损保护机制！
