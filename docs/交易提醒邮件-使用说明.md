# 交易提醒邮件功能使用说明

## 功能概述

系统在以下情况下会自动发送邮件提醒：

1. **开仓成功** - 当系统成功开仓时
2. **平仓成功** - 当系统平仓时（包括AI主动平仓、止损/止盈触发等）

## 邮件配置

在 `.env` 文件中配置 SMTP 邮件服务：

```env
# SMTP 服务器地址（如 smtp.gmail.com, smtp.qq.com）
SMTP_HOST=smtp.qq.com

# SMTP 服务器端口（587 for TLS, 465 for SSL）
SMTP_PORT=587

# SMTP 用户名（通常是邮箱地址或账号）
SMTP_USER=your_email@qq.com

# SMTP 密码或应用专用密码
SMTP_PASS=your_password

# 发件人邮箱地址
ALERT_EMAIL_FROM=your_email@qq.com

# 收件人邮箱地址（接收交易提醒）
ALERT_EMAIL_TO=your_email@qq.com
```

### 常见邮箱配置示例

#### QQ邮箱

```env
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=123456789@qq.com
SMTP_PASS=xxxxxxxxxxxxxxxx  # 使用授权码，不是QQ密码
```

获取QQ邮箱授权码：

1. 登录QQ邮箱网页版
2. 设置 -> 账户 -> POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
3. 开启 SMTP 服务，获取授权码

#### Gmail

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=xxxxxxxxxxxxxxxx  # 使用应用专用密码
```

获取Gmail应用专用密码：

1. 开启两步验证
2. 访问 <https://myaccount.google.com/apppasswords>
3. 创建应用专用密码

#### 163邮箱

```env
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=your_email@163.com
SMTP_PASS=xxxxxxxxxxxxxxxx  # 使用授权码
```

## 邮件内容

### 开仓提醒邮件包含

- 交易类型：开仓
- 币种、方向（做多/做空）
- 数量、杠杆倍数
- 入场价、保证金
- 止损价、止盈价、强平价
- 市场状态、策略类型
- 机会评分
- 订单ID、时间戳

### 平仓提醒邮件包含

- 交易类型：平仓
- 币种、方向（做多/做空）
- 数量、杠杆倍数
- 入场价、平仓价
- **盈亏金额和盈亏率**（盈利显示绿色，亏损显示红色）
- 手续费
- 平仓原因（AI主动平仓、止损触发、止盈触发等）
- 账户余额
- 订单ID、时间戳

## 测试邮件功能

运行测试脚本检查邮件配置是否正确：

```bash
npx tsx --env-file=.env ./scripts/test-email-notification.ts
```

测试脚本会发送3封测试邮件：

1. 开仓提醒（BTC做多）
2. 平仓提醒 - 盈利（BTC平仓，+250 USDT）
3. 平仓提醒 - 亏损（ETH平仓，-68 USDT）

检查您的邮箱（包括垃圾邮件文件夹）是否收到测试邮件。

## 邮件发送策略

1. **冷却期保护**：相同类型的告警5分钟内只发送一次，避免频繁打扰
2. **智能分级**：
   - 开仓：INFO级别（蓝色）
   - 平仓盈利：INFO级别（蓝色）
   - 平仓小额亏损：WARNING级别（橙色）
   - 平仓大额亏损（>100 USDT）：ERROR级别（红色）
3. **优雅降级**：如果邮件服务未配置或发送失败，系统会记录日志但不影响交易

## 故障排查

### 邮件未收到？

1. **检查配置**

   ```bash
   # 查看邮件服务是否成功初始化
   # 启动系统时应该看到：
   # "✅ 邮件告警服务已初始化 (发送至: xxx@xxx.com)"
   ```

2. **检查日志**

   ```bash
   # 查看系统日志中的邮件相关信息
   tail -f logs/pm2-out.log | grep email-alert
   ```

3. **常见问题**
   - SMTP密码错误：确保使用的是授权码/应用专用密码，不是邮箱登录密码
   - 端口被封：某些网络环境可能封禁25/465/587端口
   - 邮件被拦截：检查垃圾邮件文件夹
   - 未开启SMTP服务：在邮箱设置中开启SMTP服务

### 禁用邮件提醒

如果不需要邮件提醒，可以：

1. 不配置 SMTP 相关环境变量（系统会自动禁用邮件功能）
2. 系统会继续记录所有交易日志到日志文件

## 隐私和安全

- 邮件内容包含交易详情，请使用安全的邮箱
- 建议使用独立的邮箱账号专门接收交易提醒
- SMTP密码存储在.env文件中，请勿泄露
- 建议使用应用专用密码而非主密码

## 技术实现

相关文件：

- `src/utils/emailAlert.ts` - 邮件服务核心实现
- `src/tools/trading/tradeExecution.ts` - 开仓/平仓时调用邮件提醒
- `src/scheduler/priceOrderMonitor.ts` - 条件单触发时调用邮件提醒
- `scripts/test-email-notification.ts` - 邮件功能测试脚本

触发时机：

1. **开仓成功**：`openPositionTool` 执行成功后
2. **AI主动平仓**：`closePositionTool` 执行成功后
3. **条件单触发平仓**：`PriceOrderMonitor` 检测到止损/止盈触发后
