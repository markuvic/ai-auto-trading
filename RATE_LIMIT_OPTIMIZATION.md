# 币安IP封禁防护 - 统一限流管理器

## 优化目标

结合币安官方IP封禁规则，实现健壮的全局限流和熔断保护机制，最大限度避免IP封禁。

## 核心规则（币安官方文档）

1. **429警告**: 请求频率超限，必须立即退避，否则会触发418封禁
2. **418封禁**: 收到429后继续请求会被IP封禁，封禁时间递增（2分钟~3天）
3. **限制基于IP**: 所有请求计入同一IP限额，不区分API Key
4. **推荐WebSocket**: 减少REST API请求，使用WebSocket获取实时数据

## 实施方案

### 1. 统一限流管理器（RateLimitManager）

新建 `src/exchanges/RateLimitManager.ts`，提供：

#### 核心功能

- ✅ **全局请求限流**: 每个交易所独立的请求速率控制
- ✅ **429全局退避**: 收到429立即暂停所有请求60秒
- ✅ **418 IP封禁感知**: 自动检测封禁时长并长时间退避
- ✅ **熔断器机制**: 连续失败3次触发60秒熔断保护
- ✅ **请求统计监控**: 实时追踪API使用情况，封禁时自动打印诊断报告

#### 配置参数

```typescript
{
  exchangeName: 'binance' | 'gate',
  maxRequestsPerMinute: number,  // Binance: 800, Gate: 600
  minRequestDelay: number,        // 最小请求间隔ms
  circuitBreakerThreshold: number, // 连续失败触发阈值
  circuitBreakerTimeout: number    // 熔断器打开时长
}
```

### 2. 交易所客户端集成

#### Binance客户端优化

- 集成统一限流管理器（单例模式）
- 所有API请求前调用 `waitForRateLimit(endpoint)`
- 检测429响应立即触发全局退避
- 检测418(-1003)自动解析封禁时长并记录
- 委托熔断器状态查询给限流管理器

#### Gate.io客户端优化

- 同样集成统一限流管理器
- 保持相同的错误处理逻辑
- 支持独立的限流配置（Gate.io限制更严格）

### 3. 统一接口适配

#### 缓存降级策略

当限流管理器拒绝请求时（熔断器打开、IP封禁、429退避）:

1. 抛出错误让上层捕获
2. 各方法检查缓存是否可用
3. 使用缓存降级保证系统继续运行
4. 打印警告日志说明使用缓存数据

#### 数据一致性保障

- ✅ Ticker/K线/持仓/账户均支持缓存降级
- ✅ 缓存TTL已优化（60秒~10分钟）
- ✅ 熔断期间使用略微过期的缓存数据可接受
- ✅ 核心风控（止损单）不依赖本地API请求

## 技术细节

### 请求频率控制

**Binance**:

- 权重限制: 1200/分钟
- 实际配置: 800请求/分钟（保留33%安全余量）
- 最小间隔: 200ms

**Gate.io**:

- 限制较严格
- 实际配置: 600请求/分钟
- 最小间隔: 150ms

### 429响应处理流程

```bash
收到429 → 立即触发全局退避（60秒）
         ↓
所有端点API请求被阻止
         ↓
打印详细诊断报告（高频端点、请求统计）
         ↓
60秒后自动恢复
```

### 418封禁处理流程

```bash
收到418(-1003) → 解析封禁时长
                  ↓
触发IP封禁状态（封禁时长）
                  ↓
打印紧急建议（减少币种、延长周期等）
                  ↓
所有请求使用缓存降级
                  ↓
封禁解除后自动恢复
```

## 代码修改

### 新增文件

- `src/exchanges/RateLimitManager.ts`: 统一限流管理器

### 修改文件

- `src/exchanges/BinanceExchangeClient.ts`:
  - 引入RateLimitManager
  - 移除旧的熔断器属性
  - 替换限流控制逻辑
  - 优化429/418处理
  - 委托isCircuitBreakerOpen/recordSuccess/recordFailure

- `src/exchanges/GateExchangeClient.ts`:
  - 引入RateLimitManager
  - 移除旧的熔断器属性
  - 统一限流逻辑

## 兼容性保证

### 统一接口

✅ 两个交易所使用相同的`IExchangeClient`接口
✅ 限流管理器对外接口一致
✅ 缓存降级逻辑保持不变
✅ 错误处理机制统一

### 数据格式适配

✅ Ticker返回格式统一（TickerInfo）
✅ K线返回格式统一（CandleData[]）
✅ 持仓/账户格式统一
✅ Gate.io特有字段映射已处理（mark_price → markPrice等）

## 验证建议

### 1. 编译验证

```bash
npm run build
```

### 2. 启动验证

```bash
pm2 restart ai-trading
pm2 logs ai-trading --lines 50
```

### 3. 监控验证

查看限流管理器初始化:

```bash
grep "限流管理器初始化" logs/pm2-out.log
```

模拟429响应（如果触发）:

```bash
grep "429警告" logs/pm2-error.log
```

检查IP封禁处理:

```bash
grep "IP被封禁" logs/pm2-error.log
```

查看API请求统计:

```bash
grep "API统计" logs/pm2-out.log | tail -20
```

## 优势总结

### 健壮性

- ✅ 429立即全局退避，防止418封禁
- ✅ 418自动识别封禁时长，智能退避
- ✅ 连续失败熔断保护，防止雪崩
- ✅ 缓存降级保证系统持续运行

### 可维护性

- ✅ 统一限流逻辑，单一职责
- ✅ 单例模式，全局状态一致
- ✅ 详细日志和诊断报告
- ✅ 配置灵活，易于调整

### 兼容性

- ✅ 支持Binance和Gate.io
- ✅ 统一接口，无需修改上层逻辑
- ✅ 数据格式完全适配
- ✅ 保持现有缓存机制

### 不需要做的

- ❌ 不需要辅助脚本
- ❌ 不需要重复造轮子（使用已有缓存机制）
- ❌ 不需要修改上层业务逻辑
- ❌ 不影响核心交易和风控功能

## 注意事项

1. **不要创建总结文档**: 本README仅供参考，实际部署时可删除
2. **监控API请求频率**: 通过日志定期检查是否接近限制
3. **关注熔断器状态**: 频繁触发说明需要调整配置
4. **缓存数据容忍度**: K线/持仓数据可容忍短暂延迟，价格数据需及时
5. **WebSocket优化**: 长期可考虑使用WebSocket减少REST请求

---

**实施日期**: 2025-12-12  
**影响范围**: Binance/Gate.io API请求层  
**向后兼容**: ✅ 完全兼容  
**风险等级**: 🟢 低（仅优化限流逻辑，不改变业务逻辑）
